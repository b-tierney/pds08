---
title: "pds08.Rmd"
author: "Braden T Tierney"
date: "10/8/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(umap)
library(cowplot)
library(vegan)
library(ggrepel)

theme_set(theme_cowplot())
```

```{r}
#UMAP BASELINE, DELTA, ENDPOINT

setwd('~/Desktop/google_drive/My Drive/pds08/')

baseline_metaphlan = readRDS('metaphlan_baseline.rds') %>% mutate(Sample_ID = paste(Sample_ID,'_baseline',sep=''))
endpoint_metaphlan = readRDS('metaphlan_endpoint.rds') %>% mutate(Sample_ID = paste(Sample_ID,'_endpoint',sep=''))
delta_metaphlan = readRDS('metaphlan_delta.rds') %>% mutate(Sample_ID = paste(Sample_ID,'_delta',sep=''))

metadata = readRDS('pds08_metadata.rds')

metaphlan_b_e = bind_rows(baseline_metaphlan,endpoint_metaphlan) %>% column_to_rownames('Sample_ID') 
metaphlan_b_e_umap = umap(metaphlan_b_e)

umap_output = metaphlan_b_e_umap$layout %>% data.frame %>% rownames_to_column('key') %>% as.tibble %>% mutate(Sample_ID = strsplit(key,'_') %>% map_chr(1),timepoint = strsplit(key,'_') %>% map_chr(2))
umap_output = left_join(umap_output,metadata,by='Sample_ID')

ggplot(data = umap_output %>% filter(timepoint == 'baseline'),aes(x=X1,y=X2,group=Sample_ID,color=as.factor(d_bm3))) + geom_point(size=3,aes(shape=timepoint)) + geom_line(color='grey') 
ggplot(data = umap_output %>% filter(timepoint == 'endpoint'),aes(x=X1,y=X2,group=Sample_ID,color=as.factor(d_bm3))) + geom_point(size=3,aes(shape=timepoint)) + geom_line(color='grey') 
ggplot(data = umap_output,aes(x=X1,y=X2,group=Sample_ID,color=as.factor(d_bm3))) + geom_point(size=3,aes(shape=timepoint)) + geom_line(color='grey') 

delta_metaphlan = delta_metaphlan %>% column_to_rownames('Sample_ID') 
metaphlan_delta_umap = umap(metaphlan_b_e)

umap_output = metaphlan_delta_umap$layout %>% data.frame %>% rownames_to_column('key') %>% as.tibble %>% mutate(Sample_ID = strsplit(key,'_') %>% map_chr(1),timepoint = strsplit(key,'_') %>% map_chr(2))
umap_output = left_join(umap_output,metadata,by='Sample_ID')

ggplot(data = umap_output,aes(x=X1,y=X2,group=Sample_ID,color=as.factor(d_bm3))) + geom_point(size=3,aes(shape=rx))

#pca = prcomp(metaphlan_b_e %>% t,center = T)
#metaphlan_b_e_pca = pca$rotation[,1:5]

#metaphlan_b_e_pca = metaphlan_b_e_pca%>% data.frame %>% rownames_to_column('key') %>% as.tibble %>% mutate(Sample_ID = strsplit(key,'_') %>% map_chr(1),timepoint = strsplit(key,'_') %>% map_chr(2))
#pca_output = left_join(metaphlan_b_e_pca,metadata,by='Sample_ID')

#ggplot(data = pca_output,aes(x=PC1,y=PC2,group=Sample_ID,color=as.factor(rx))) + geom_point(aes(shape=timepoint)) + geom_line(color='grey')

```

```{r}
# beta diversity 
setwd('~/Desktop/google_drive/My Drive/pds08/')

baseline_metaphlan = readRDS('metaphlan_baseline.rds') %>% column_to_rownames('Sample_ID') 
endpoint_metaphlan = readRDS('metaphlan_endpoint.rds')   %>% column_to_rownames('Sample_ID') 
delta_metaphlan = readRDS('metaphlan_delta.rds')  %>% column_to_rownames('Sample_ID') 

metadata = readRDS('pds08_metadata.rds')  %>% column_to_rownames('Sample_ID') 
metadata$d_bm1 = as.factor(metadata$d_bm1)
metadata$d_bm2 = as.factor(metadata$d_bm2)
metadata$d_bm3 = as.factor(metadata$d_bm3)
metadata$d_bristol = as.factor(metadata$d_bristol)

metadata = metadata[rownames(baseline_metaphlan),]
# baseline
beta_dist = as.matrix(vegdist(baseline_metaphlan,index = "bray"))

pheatmap::pheatmap(mat = beta_dist, show_rownames = F,show_colnames = T,cluster_rows=T,cluster_cols =T,annotation_row = metadata %>% select(b_bristol,b_pain,b_bm_weekly))

# endpoint
beta_dist = as.matrix(vegdist(endpoint_metaphlan,index = "bray"))

pheatmap::pheatmap(mat = beta_dist, show_rownames = F,show_colnames = T,cluster_rows=T,cluster_cols =T,annotation_row = metadata %>% select(d_bm1,d_bm2,d_bm3,rx))
```

```{r}
# alpha diversity -- baseline, clinical variables
setwd('~/Desktop/google_drive/My Drive/pds08/')

baseline = list.files('metaphlan_associations')
baseline = baseline[grep('baseline',baseline)]
baseline = baseline[grep('diversity',baseline)]
baseline = baseline[grep('metaphlan',baseline)]
baseline = baseline[grep('outcome',baseline)]

data = list()
for(f in baseline){
  d = readRDS(paste('metaphlan_associations/',f,sep='')) %>% mutate(var = gsub('_metaphlan_baseline_diversity.rds','',gsub('regression_output_outcome_microbe_','',f)))
  data[[f]] =d
}

bind_rows(data)%>% filter(p.value<0.1)
```

```{r}
# alpha diversity -- delta, clinical variables
setwd('~/Desktop/google_drive/My Drive/pds08/')

delta = list.files('metaphlan_associations')
delta = delta[grep('delta',delta)]
delta = delta[grep('diversity',delta)]
delta = delta[grep('metaphlan',delta)]
delta = delta[grep('outcome',delta)]

data = list()
for(f in delta){
  d = readRDS(paste('metaphlan_associations/',f,sep='')) %>% mutate(var = gsub('_metaphlan_delta_diversity.rds','',gsub('regression_output_outcome_microbe_','',f)))
  data[[f]] =d
}

bind_rows(data) %>% filter(p.value<0.1)
```

```{r}
# alpha diversity -- endpoint, clinical variables
setwd('~/Desktop/google_drive/My Drive/pds08/')

endpoint = list.files('metaphlan_associations')
endpoint = endpoint[grep('endpoint',endpoint)]
endpoint = endpoint[grep('diversity',endpoint)]
endpoint = endpoint[grep('metaphlan',endpoint)]
endpoint = endpoint[grep('outcome',endpoint)]

data = list()
for(f in endpoint){
  d = readRDS(paste('metaphlan_associations/',f,sep='')) %>% mutate(var = gsub('_metaphlan_endpoint_diversity.rds','',gsub('regression_output_outcome_microbe_','',f)))
  data[[f]] =d
}

bind_rows(data) %>% filter(p.value<0.1)
```

```{r}
# alpha diversity -- treatment
setwd('~/Desktop/google_drive/My Drive/pds08/')

baseline_alpha = readRDS('./metaphlan_associations/regression_output_microbe_treatment_metaphlan_baseline_diversity.rds') %>% mutate()
endpoint_alpha = readRDS('./metaphlan_associations/regression_output_microbe_treatment_metaphlan_endpoint_diversity.rds') %>% mutate()
delta_alpha = readRDS('./metaphlan_associations/regression_output_microbe_treatment_metaphlan_delta_diversity.rds') %>% mutate()

baseline_alpha
endpoint_alpha
delta_alpha
```
```{r}
#FIGURE stuff to look at --

# F1 -- BASELINE ANALYSIS

# note -- will need shannon supp figs for everything

# bristol (baseline and endpoint) for simpson* and richness*

# delta_alpha for simpson and richness*


```

```{r}
get_volcanos <- function(regression_output,output_folder){
  features = unique(regression_output$var)
  for(f in features){
    data_sub = regression_output %>% filter(var==f)
    plotout = ggplot(data=data_sub,aes(x=estimate,y=-log10(bh),label=term))+geom_point()+geom_hline(yintercept = -log10(0.05),linetype='dashed') + ggtitle(f) + ylab('-log10(qval)') +ggtitle('') + xlim(-5,5) + ylim(0,11) + geom_label_repel(data = data_sub %>% arrange(bh) %>% filter(bh<0.05) %>% head(10),aes(label = term),
                  box.padding   = 0.1, 
                  point.padding = 0.1,
                  max.overlaps=100,
                  size=3,
                  segment.color = 'grey50')
    ggsave(paste(output_folder,f,'_volcano.pdf',sep=''),width=10,height=10)
  }
}
```

```{r}
# regression output -- BASELINE, CLINICAL

setwd('~/Desktop/google_drive/My Drive/pds08/metaphlan_associations')

files = list.files()
files = files[grep('baseline',files)]
files = files[-grep('diversity',files)]
files = files[grep('metaphlan',files)]
files = files[grep('outcome',files)]

data = list()
for(f in files){
  d = readRDS(paste(f,sep='')) %>% mutate(var = gsub('_metaphlan_baseline.rds','',gsub('regression_output_outcome_microbe_','',f)))
  data[[f]] =d
}

baseline_metaphlan_merged = bind_rows(data)
baseline_metaphlan_merged = baseline_metaphlan_merged %>% filter(term!='k__Bacteria')
baseline_metaphlan_merged = baseline_metaphlan_merged %>% mutate(term = gsub("^.*\\|", "", term))

get_volcanos(baseline_metaphlan_merged,'volcano_plots_baseline/')

```


```{r}
# regression output -- DELTA, CLINICAL

setwd('~/Desktop/google_drive/My Drive/pds08/metaphlan_associations')

files = list.files()
files = files[grep('endpoint',files)]
files = files[-grep('diversity',files)]
files = files[grep('metaphlan',files)]
files = files[grep('outcome',files)]

data = list()
for(f in files){
  d = readRDS(paste(f,sep='')) %>% mutate(var = gsub('_metaphlan_baseline.rds','',gsub('regression_output_outcome_microbe_','',f)))
  data[[f]] =d
}

baseline_metaphlan_merged = bind_rows(data)
baseline_metaphlan_merged = baseline_metaphlan_merged %>% filter(term!='k__Bacteria')
baseline_metaphlan_merged = baseline_metaphlan_merged %>% mutate(term = gsub("^.*\\|", "", term))

get_volcanos(baseline_metaphlan_merged,'volcano_plots_endpoint/')

```

```{r}
# regression output -- ENDPOINT, CLINICAL

setwd('~/Desktop/google_drive/My Drive/pds08/metaphlan_associations')

files = list.files()
files = files[grep('delta',files)]
files = files[-grep('diversity',files)]
files = files[grep('metaphlan',files)]
files = files[grep('outcome',files)]

data = list()
for(f in files){
  d = readRDS(paste(f,sep='')) %>% mutate(var = gsub('_metaphlan_baseline.rds','',gsub('regression_output_outcome_microbe_','',f)))
  data[[f]] =d
}

baseline_metaphlan_merged = bind_rows(data)
baseline_metaphlan_merged = baseline_metaphlan_merged %>% filter(term!='k__Bacteria')
baseline_metaphlan_merged = baseline_metaphlan_merged %>% mutate(term = gsub("^.*\\|", "", term))

get_volcanos(baseline_metaphlan_merged,'volcano_plots_delta/')

```